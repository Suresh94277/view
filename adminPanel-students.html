<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Admin Panel | Student Management System</title>

    <!-- <link rel="stylesheet" href="./assets/css/vendors.bundle.css"> -->
    <!-- <link href="./assets/css/datatables.bundle.css" rel="stylesheet" type="text/css" /> -->
    <link href="./assets/css/style.bundle.css" rel="stylesheet" type="text/css" />
    <link href="./assets/css/vendors.bundle.css" rel="stylesheet" type="text/css" />
    <link href="./assets/css/custom.css" rel="stylesheet" type="text/css" />

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.16/webfont.js"></script>
    <script>
        WebFont.load({
            google: {"families":["Poppins:300,400,500,600,700"]},
            active: function() {
                sessionStorage.fonts = true;
            }
        });
    </script>
  <style>
    aside.sidebar {
        position: fixed;
        left: 0;
        top: 51px;
        bottom: 0;
        width: 200px;
        background-color: #343a40;
    }
    aside.sidebar > ul > li {
        background-color: unset;
        color: rgba(255,255,255,.5);
    }
    #contentWrapper{
        margin-left: 200px;
    }
    .sidebar .list-group-item {
        border: none !important;
        padding-top: 15px ;
        padding-bottom: 15px ;
    }
    form .row:last-child .form-group {
      margin-bottom: 0;
    }
</style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <a class="navbar-brand" href="#">Result Management System</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" 
      data-target="#navbarTogglerDemo02" aria-controls="navbarTogglerDemo02" 
      aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarTogglerDemo02">
          <ul class="navbar-nav ml-auto mt-2 mt-lg-0">
          <li class="nav-item">
              <a class="nav-link" href="javascript:;" onclick="logoutMe()">Log out</span></a>
          </li>
          </ul>
      </div>
  </nav>
<main>
    <aside class="sidebar">
        <ul class="list-group">
          <li class="list-group-item rounded-0 active">
              <a href="adminPanel-students.html" class="text-light">Students</a>
          </li>
          <li class="list-group-item rounded-0">
              <a href="adminPanel-results.html" class="text-light">Results</a>
          </li>
          <li class="list-group-item rounded-0">
              <a href="adminPanel-teachers.html" class="text-light">Teachers</a>
          </li>
      </ul>
    </aside>

    <section id="contentWrapper">
        <div class="wrapper">
            <div class="right-section-students">
                <div class="p-3">
                    <h3 class="float-left">Students <small class="fa fa-redo ml-3 refreshTable" title="Refresh table" style="font-size: 14px;"></small></h3>
                    <button type="button" data-toggle="modal" data-target="#students-add-modal"
                    class="btn btn-primary m-btn float-right btn-sm">Add Student</button>
                </div>

                <div id="studentTableCon" class="p-3 mt-3">
                    <table id="studentTable">
                    </table>
                </div>
            </div>
        </div>
    </section>
</main>

  <div class="modal fade" id="students-add-modal">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h5 class="modal-title text-white" id="students-add">Create Student</h5>
                <button type="button" class="close text-light" data-dismiss="modal" aria-label="Close">
                </button>
            </div>
            <div class="modal-body bg-light">
                <form id="student-create-form">
                  <div class="row">
                    <div class="col-md-2">
                      <div class="form-group">
                          <label for="student-id" class="form-control-label">Student ID:</label>
                          <input type="text" name="id" autocomplete="off" class="form-control" id="student-id">
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="form-group">
                          <label for="student-first-name" class="form-control-label">First Name:</label>
                          <input type="text" name="fname" autocomplete="off" class="form-control" id="student-first-name">
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="form-group">
                          <label for="student-mid-name" class="form-control-label">Mid Name:</label>
                          <input type="text" name="mname" autocomplete="off" class="form-control" id="student-mid-name">
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-group">
                          <label for="student-last-name" class="form-control-label">Last Name:</label>
                          <input type="text" name="lname" autocomplete="off" class="form-control" id="student-last-name">
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-2">
                      <div class="form-group">
                        <label for="student-dob" class="form-control-label">Date of Birth:</label>
                        <input type="text" name="dob" autocomplete="off" class="form-control" id="student-dob">
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="student-parent-name" class="form-control-label">Parent Name:</label>
                        <input type="text" name="parent_name" autocomplete="off" class="form-control" id="student-parent-name">
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-group">
                        <label for="student-parent-phone" class="form-control-label">Parent Phone:</label>
                        <input type="text" name="parent_phone" autocomplete="off" class="form-control" id="student-parent-phone">
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-2">
                      <div class="form-group">
                        <label for="student-class" class="form-control-label">Class:</label>
                        <select name="standard" id="student-class" class="form-control" title="Choose">
                        </select>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="student-address" class="form-control-label">Address:</label>
                        <input type="text" name="address" autocomplete="off" id="student-address" class="form-control">
                      </div>
                    </div>
                    <div class="col-md-2">
                      <div class="form-group">
                        <label for="student-blood-group" class="form-control-label">Blood Group:</label>
                        <select name="blood_group" title="Choose" id="student-blood-group" class="form-control"></select> 
                      </div>
                    </div>
                    <div class="col-md-2">
                      <div class="form-group">
                        <label for="student-gender" class="form-control-label">Gend er:</label>
                        <select name="gender" title="Choose" id="student-gender" class="form-control">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Others">Others</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                      <div class="col-md-6">
                          <label for="img-file" class="form-control-label">Image:</label>
                          <input type="file" name="imageFile" class="form-control" id="img-file">
                      </div>
                  </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary mr-auto btn-pill" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary btn-pill" 
                onclick="$('#student-create-form').submit()">Create</button>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="students-edit-modal">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h5 class="modal-title text-white" id="students-edit">Edit Student</h5>
                <button type="button" class="close text-light" data-dismiss="modal" aria-label="Close">
                </button>
            </div>
            <div class="modal-body bg-light">
                <form id="student-edit-form">
                  <div class="row">
                    <div class="col-md-2">
                      <div class="form-group">
                          <label for="student-edit-id" class="form-control-label">Student ID:</label>
                          <input type="text" name="id" autocomplete="off" class="form-control" id="student-edit-id">
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="form-group">
                          <label for="student-edit-first-name" class="form-control-label">First Name:</label>
                          <input type="text" name="fname" autocomplete="off" class="form-control" id="student-edit-first-name">
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="form-group">
                          <label for="student-edit-mid-name" class="form-control-label">Mid Name:</label>
                          <input type="text" name="mname" autocomplete="off" class="form-control" id="student-edit-mid-name">
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-group">
                          <label for="student-edit-last-name" class="form-control-label">Last Name:</label>
                          <input type="text" name="lname" autocomplete="off" class="form-control" id="student-edit-last-name">
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-2">
                      <div class="form-group">
                        <label for="student-edit-dob" class="form-control-label">Date of Birth:</label>
                        <input type="text" name="dob" autocomplete="off" class="form-control" id="student-edit-dob">
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="student-edit-parent-name" class="form-control-label">Parent Name:</label>
                        <input type="text" name="parent_name" autocomplete="off" class="form-control" id="student-edit-parent-name">
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-group">
                        <label for="student-edit-parent-phone" class="form-control-label">Parent Phone:</label>
                        <input type="text" name="parent_phone" autocomplete="off" class="form-control" id="student-edit-parent-phone">
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-2">
                      <div class="form-group">
                        <label for="student-edit-class" class="form-control-label">Class:</label>
                        <select name="standard" id="student-edit-class" class="form-control" title="Choose">
                        </select>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="student-edit-address" class="form-control-label">Address:</label>
                        <input type="text" name="address" autocomplete="off" id="student-edit-address" class="form-control">
                      </div>
                    </div>
                    <div class="col-md-2">
                      <div class="form-group">
                        <label for="student-edit-blood-group" class="form-control-label">Blood Group:</label>
                        <select name="blood_group" title="Choose" id="student-edit-blood-group" class="form-control"></select> 
                      </div>
                    </div>
                    <div class="col-md-2">
                      <div class="form-group">
                        <label for="student-edit-gender" class="form-control-label">Genger:</label>
                        <select name="gender" title="Choose" id="student-edit-gender" class="form-control">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Others">Others</option>
                        </select>
                      </div>
                    </div>
                    
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                        <label for="img-file" class="form-control-label">Image:</label>
                        <input type="file" name="imageFile" class="form-control" id="img-file">
                    </div>
                    <div class="col-md-2">
                        <img id="img-target" src="" alt="avatar" class="img-fluid">
                    </div>
                </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary mr-auto btn-pill" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary btn-pill" 
                onclick="$('#student-edit-form').submit()">Update</button>
            </div>
        </div>
    </div>
  </div>
  
  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="./assets/js/colors.js"></script>
<script src="./assets/js/vendors.bundle.js"></script>
<script src="./assets/js/scripts.bundle.js"></script>
<script src="./assets/js/datatables.bundle.js" type="text/javascript"></script>

<script>
    $(function(mytoken) {
        $.get({
            url: 'http://localhost:5000/api/auth/check',
            beforeSend(xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer '+ mytoken);
            }
        }).then( response => {
            if(!response.auth) {
                localStorage.removeItem('token');
                location.href = 'login.html';
            } else {
                if(['admin', 'teacher'].indexOf(response.user.role.toLowerCase()) === -1) {
                    location.href = 'index.html';
                    return;
                }
                if(localStorage.getItem('just_login') !== 'true') return;
                toastr.info('Welcome '+ response.user.name +', to the admin panel.');
                localStorage.removeItem('just_login');
            }
        });


        $('#student-dob, #student-edit-dob').datepicker({
          format: 'mm/dd/yyyy',
          autoclose:true
        });

        $('#student-class, #student-edit-class').selectpicker({
          width: '100%'
        });
        $.get('http://localhost:5000/api/classes/list').then(list => {
            list = list.map(x => `<option value="${x.id}">${x.text}</option>`);
            $('#student-class, #student-edit-class').html(list).selectpicker('refresh');
        });

        $('#student-blood-group, #student-edit-blood-group').selectpicker({
          width: '100%'
        });
        $.get('http://localhost:5000/api/classes/blood-group').then(list => {
            list = list.map(x => `<option value="${x.id}">${x.text}</option>`);
            $('#student-blood-group, #student-edit-blood-group').html(list).selectpicker('refresh');
        });

        $('#student-gender, #student-edit-gender').selectpicker({width: '100%'});

        $('#student-create-form').off('submit').on('submit', async function(e) {
            e.preventDefault();
            const form = $(this);
            const data = form.serializeArray();

            let execute = true;
            await $.post({
              url: 'http://localhost:5000/api/users/upload',
              contentType: false,
              processData: false,
              data: new FormData(this)
            }).then(response => {
              data.push({name: 'image', value: response.filename});
            }, err => {
              toastr.error('Please choose image first')
              execute = false;
            });
            if(!execute) return;
            $.post({
                url: 'http://localhost:5000/api/students/create', 
                data,
                beforeSend(xhr) {
                    const token = localStorage.getItem('token');
                    xhr.setRequestHeader('Authorization', 'Bearer '+ token);
                }
            })
            .then(response => {
                toastr.success('Student created successfully.');
                $('.modal.show').modal('hide');
                form.resetForm();
                reloadStudents();
            }, err => {
                toastr.error('Something went wrong.');
            });
        });
        $('#student-edit-form').off('submit').on('submit', async function(e) {
            e.preventDefault();
            const form = $(this);
            const data = form.serializeArray();

            let execute = true;

            await $.post({
              url: 'http://localhost:5000/api/users/upload',
              contentType: false,
              processData: false,
              data: new FormData(this)
            }).then(response => {
              data.push({name: 'image', value: response.filename});
            }, err => 1)


            $.post({
                url: 'http://localhost:5000/api/students/update/' + form.attr('data-id'), 
                data,
                beforeSend(xhr) {
                    const token = localStorage.getItem('token');
                    xhr.setRequestHeader('Authorization', 'Bearer '+ token);
                }
            })
            .then(response => {
                toastr.success('Student created successfully.');
                $('.modal.show').modal('hide');
                form.resetForm();
                reloadStudents();
            }, err => {
                toastr.error('Something went wrong.');
            });
        });

    }( localStorage.getItem('token') ))
</script>
<script src="./assets/js/students.js"></script>

</body>
</html>